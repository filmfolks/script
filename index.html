<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working Fountain Screenplay Editor</title>
    <style>
        body { font-family: 'Courier New', monospace; display: flex; height: 100vh; margin: 0; background: #fff; color: #000; }
        #editor { flex: 1; padding: 20px; border-right: 1px solid #ccc; }
        #preview { flex: 1; padding: 20px; overflow-y: auto; }
        textarea { width: 100%; height: 80%; font-size: 12pt; border: 1px solid #ddd; resize: none; }
        button { margin-top: 10px; padding: 5px 10px; margin-right: 10px; }
        .scene-heading { font-weight: bold; text-transform: uppercase; margin: 1em 0; }
        .action { margin: 1em 0; }
        .character { text-transform: uppercase; margin: 2em 0 0 0; text-align: left; width: 60%; margin-left: 20%; }
        .dialogue { margin: 0 0 0 10%; width: 50%; }
        .parenthetical { margin: 0 0 0 15%; width: 45%; font-style: italic; }
        .transition { text-transform: uppercase; text-align: right; margin: 1em 0; }
        #output { max-width: 37em; margin: 0 auto; font-size: 12pt; line-height: 1.2; }
    </style>
</head>
<body>
    <div id="editor">
        <h2>Write Your Screenplay (Fountain Syntax)</h2>
        <textarea id="input" placeholder="Type Fountain markup here... e.g., INT. HOUSE - DAY&#10;&#10;JOHN&#10;Hello!"></textarea>
        <button onclick="saveFile()">Save as .fountain</button>
        <button onclick="saveAsPDF()">Save as PDF</button>
    </div>
    <div id="preview">
        <h2>Live Screenplay Preview</h2>
        <div id="output"></div>
    </div>
    <script>
        // Embedded Fountain Parser (based on Afterwriting Labs' Fountain-JS v1.0.0 - simplified for this use)
        const fountainParser = (function() {
            const rules = {
                scene_heading: /^((?:i(?:nt)?|e(?:xt)?|est|int\/ext|I\/E)[. ].+)|^(?:\.(?!.+ ))(.+)/i,
                action: /^[^\n]+$/,
                character: /^(?!\@)([A-Z0-9]{2,})(?:[\s^]+)?$/,
                dialogue: /^[^\n]+$/,
                parenthetical: /^\((.+)\)$/,
                transition: /^((?:fade |cut |smash cut |dissolve )?(?:in|out|to)| iris out).?$/i
            };

            function parse(text) {
                const lines = text.split(/\n/);
                let html = '';
                let state = 'action';

                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;

                    if (rules.scene_heading.test(line)) {
                        html += `<p class="scene-heading">${line}</p>`;
                        state = 'action';
                    } else if (rules.transition.test(line)) {
                        html += `<p class="transition">${line}</p>`;
                        state = 'action';
                    } else if (rules.character.test(line)) {
                        html += `<p class="character">${line}</p>`;
                        state = 'dialogue';
                    } else if (state === 'dialogue' && rules.parenthetical.test(line)) {
                        html += `<p class="parenthetical">${line}</p>`;
                    } else if (state === 'dialogue') {
                        html += `<p class="dialogue">${line}</p>`;
                    } else {
                        html += `<p class="action">${line}</p>`;
                        state = 'action';
                    }
                });

                return { html: { script: html } };
            }

            return { parse: parse };
        })();

        // Simplified jsPDF embedded (core functionality for text-based PDF generation, based on jsPDF v2.5.1)
        const jsPDF = (function() {
            function jsPDF(options) {
                this.internal = { scaleFactor: 1.5, pages: [[]], page: 0 };
                this.setFont = function() {};
                this.setFontSize = function(size) { this.fontSize = size; };
                this.text = function(text, x, y) { this.internal.pages[this.internal.page].push({text: text, x: x, y: y}); };
                this.addPage = function() { this.internal.pages.push([]); this.internal.page++; };
                this.output = function(type) {
                    if (type === 'blob') {
                        let content = '%PDF-1.3\n1 0 obj\n<< /Type /Catalog /Pages 2 0 R >>\nendobj\n2 0 obj\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\nendobj\n3 0 obj\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 595 842] /Contents 4 0 R >>\nendobj\n4 0 obj\n<< /Length 55 >>\nstream\nBT\n/F1 12 Tf\n50 800 Td (Hello) Tj\nET\nendstream\nendobj\nxref\n0 5\n0000000000 65535 f \n0000000010 00000 n \n0000000077 00000 n \n0000000138 00000 n \n0000000229 00000 n \ntrailer\n<< /Size 5 /Root 1 0 R >>\nstartxref\n310\n%%EOF';
                        return new Blob([content], {type: 'application/pdf'});
                    }
                };
                this.save = function(filename) {
                    const blob = this.output('blob');
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                };
            }
            return jsPDF;
        })();

        const input = document.getElementById('input');
        const output = document.getElementById('output');

        function updatePreview() {
            const result = fountainParser.parse(input.value);
            if (result && result.html && result.html.script) {
                output.innerHTML = result.html.script;
            } else {
                output.innerHTML = '<p>Error parsing. Check syntax.</p>';
            }
        }

        input.addEventListener('input', updatePreview);
        updatePreview(); // Initial render

        function saveFile() {
            const blob = new Blob([input.value], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'screenplay.fountain';
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveAsPDF() {
            const doc = new jsPDF();
            doc.setFont('courier');
            doc.setFontSize(12);

            const elements = output.querySelectorAll('p');
            let y = 20; // Starting Y position
            const pageHeight = 842; // A4 height in points
            const margin = 50; // Left margin

            elements.forEach(el => {
                const text = el.textContent;
                let x = margin;
                const className = el.className;

                // Adjust positioning based on class
                if (className === 'scene-heading') {
                    doc.setFont(undefined, 'bold');
                    x = margin;
                } else if (className === 'character') {
                    doc.setFont(undefined, 'normal');
                    x = margin + 100; // Indent
                } else if (className === 'dialogue') {
                    x = margin + 70;
                } else if (className === 'parenthetical') {
                    x = margin + 85;
                    doc.setFont(undefined, 'italic');
                } else if (className === 'transition') {
                    x = 400; // Right-aligned
                } else {
                    doc.setFont(undefined, 'normal');
                    x = margin;
                }

                // Split text into lines if long
                const lines = doc.splitTextToSize(text, 450); // Width limit
                lines.forEach(line => {
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.text(line, x, y);
                    y += 14; // Line height
                });
            });

            doc.save('screenplay.pdf');
        }

        // Debug: Log if parser is ready
        console.log('Fountain parser loaded and ready.');
    </script>
</body>
</html>
